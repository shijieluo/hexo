---
title: 静态链接
date: 2018-07-01 20:21:31
categories: 程序员的自我修养
tags:
- 静态链接
---
# 静态链接
静态链接，顾名思义，即在装载和运行之前进行链接操作。

输入文件：多个.o文件。

输出文件: 一个可执行文件。

## 静态链接的空间与地址分配
分配方式有：
* 按序叠加：即object文件中的段按照顺序叠加成为一个output文件。
* 相似段合并： 即把相似的段合并到一起。即将多个object的.text段，.data段,.bss段等分别合并。

现代链接器空间分配策略一般为第二种。整个链接的过程分为二部：
- 第一步 空间与地址分配。 扫描所有的输入文件，获得各个段的长度，属性和位置，并将输入文件中的所有符号收集起来，放到全局符号表中。然后计算输出文件每个段的位置和长度，并建立映射关系。
- 第二部 符号解析与重定位。根据第一步收集的所有信息，读取输入文件中段的数据，重定位信息，并进行符号解析与重定位，调整代码中的地址。

## 符号解析与重定位
### 重定位
一开始，每个.o文件都是从地址0开始，等到空间分配完成后，各个函数或变量才会确定自己的虚拟地址空间中的位置。
一般有两种重定位指令
- 相对地址指令。比如call指令。
- 绝对地址指令。比如mov指令。

### 重定位表
对于每个可重定位的ELF文件来说，必须包含重定位表。对于静态链接。数据段的重定位信息一般放在.rel.data,代码段的重定位信息放在.rel.text。
重定位表中的偏移表示需要重定位的地址。

### 符号解析
链接器需要对函数，变量的符号进行解析，因为我们目标文件中用到的符号可能定义在其他文件中，对于一个目标文件符号表中的UND项，链接后要在全局符号表中找到相应的地址，然后进行重定位。
如果未能找到，则编译器报为定义的错误。

### 指令修正方式
对于不同体系结构的处理器来说，寻址方式和地址格式都可能不一样。而对于32位x86平台，指令的寻址方式一般只有两种。（上面已经提到）。
* 绝对地址修正。 修正位置的值为S+A。S代表符号在虚拟地址空间中的实际值，A表示修正位置里存放的值。
* 相对地址修正。修正位置的值为 S+A-P。P表示修正的位置地址。

## COMMON块
主要为了处理弱符号机制。分三种情况：
* 两个或两个以上的强符号类型不一致。报错
* 有一个强符号，其他都是弱符号，出现类型不一致。选择强符号。
* 两个或两个以上的弱符号类型不一致。选择COMMON类型占空间较大的那块。

